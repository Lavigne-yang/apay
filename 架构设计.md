---

### **1. 核心服务模块划分**

#### **(1) 网关服务（API Gateway）**

- **职责**：
    - 统一入口：处理所有外部请求（商户端、管理端）。
    - 路由转发：将请求分发到对应的微服务。
    - 认证鉴权：验证 API 签名、商户身份（如 JWT/OAuth2）。
    - 限流熔断：防止高并发场景下的服务雪崩（如 Sentinel、Resilience4j）。
- **技术选型**：
    - Spring Cloud Gateway / Zuul
    - Spring Security / OAuth2

#### **(2) 支付核心服务（Payment Service）**

- **职责**：
    - **订单管理**：生成支付订单，记录订单状态（待支付、成功、失败）。
    - **支付路由**：根据支付方式（微信、支付宝等）选择对应的渠道适配器。
    - **异步通知**：处理支付渠道的回调，更新订单状态。
- **数据库**：
    - 支付订单表（`payment_order`）：存储订单号、金额、状态、渠道信息等。
- **接口示例**：
  ```java
  @PostMapping("/create")
  public PaymentResponse createOrder(@RequestBody PaymentRequest request);
  ```

#### **(3) 渠道适配服务（Channel Adapter Service）**

- **职责**：
    - **渠道对接**：封装不同支付渠道的 SDK 或 API（如微信支付、支付宝、银联）。
    - **协议转换**：将内部统一支付请求转换为渠道特定格式。
    - **结果处理**：解析渠道返回的结果并标准化。
- **子服务拆分**（按渠道隔离）：
    - 微信支付适配器（WechatPay-Adapter）
    - 支付宝适配器（Alipay-Adapter）
    - 银联适配器（UnionPay-Adapter）
- **技术选型**：
    - 各渠道官方 SDK + Feign Client（HTTP 调用）

#### **(4) 退款服务（Refund Service）**

- **职责**：
    - 处理退款请求，调用对应支付渠道的退款接口。
    - 记录退款流水，更新订单状态。
- **数据库**：
    - 退款记录表（`refund_record`）：关联原订单、退款金额、状态。
- **接口示例**：
  ```java
  @PostMapping("/submit")
  public RefundResponse submitRefund(@RequestBody RefundRequest request);
  ```

#### **(5) 对账服务（Reconciliation Service）**

- **职责**：
    - **定时对账**：每日从支付渠道拉取交易账单，与本地订单比对。
    - **差异处理**：自动或手动修复账务差异（如漏单、金额不一致）。
- **技术选型**：
    - Quartz / XXL-JOB（定时任务）
    - 文件解析（CSV/Excel） + 对账算法

#### **(6) 风控服务（Risk Control Service）**

- **职责**：
    - **规则引擎**：实时检测交易风险（如 IP 异常、大额交易）。
    - **黑名单管理**：拦截高风险商户或用户。
    - **限流控制**：根据规则限制交易频率。
- **技术选型**：
    - Drools / Easy Rules（规则引擎）
    - Redis（黑名单缓存）

---

### **2. 辅助服务模块**

#### **(1) 商户服务（Merchant Service）**

- **职责**：
    - 商户信息管理：注册、审核、密钥分配。
    - 权限控制：商户 API 权限配置。
- **数据库**：
    - 商户表（`merchant`）：存储商户 ID、密钥、状态等。

#### **(2) 账户服务（Account Service）**

- **职责**：
    - 资金账户管理：商户余额、冻结资金。
    - 交易流水记录：入账、出账、结算记录。
- **数据库**：
    - 账户表（`account`）、流水表（`transaction`）。

#### **(3) 通知服务（Notification Service）**

- **职责**：
    - 异步通知商户支付结果（HTTP 回调、短信、邮件）。
    - 重试机制：失败通知的自动重试（如 RabbitMQ 死信队列）。
- **技术选型**：
    - RabbitMQ / Kafka（消息队列）
    - Webhook（HTTP 回调）

---

### **3. 基础设施服务**

#### **(1) 服务注册与发现（Service Registry）**

- **职责**：管理微服务的注册与发现。
- **技术选型**：
    - Nacos / Eureka / Consul

#### **(2) 配置中心（Config Center）**

- **职责**：集中管理微服务配置（多环境支持）。
- **技术选型**：
    - Nacos Config / Spring Cloud Config

#### **(3) 日志与监控（Logging & Monitoring）**

- **职责**：
    - 日志收集：ELK（Elasticsearch + Logstash + Kibana）。
    - 链路追踪：SkyWalking / Zipkin。
    - 指标监控：Prometheus + Grafana。

#### **(4) 消息队列（Message Queue）**

- **职责**：解耦服务间的异步通信。
- **技术选型**：
    - RabbitMQ（事务消息）
    - Kafka（高吞吐场景）

---

### **4. 数据库设计原则**

- **分库分表**：按业务垂直拆分（支付库、商户库、账户库）。
- **读写分离**：主库写，从库读（如 ShardingSphere）。
- **数据一致性**：
    - 最终一致性：通过消息队列补偿（如订单状态同步）。
    - 强一致性：使用 Seata（分布式事务）。

---

### **5. 部署架构示例**

```
+------------------+       +------------------+
|   API Gateway    |       |   商户管理端      |
+------------------+       +------------------+
         ↓                           ↓
+------------------+       +------------------+
|   支付核心服务     | ←→ |    渠道适配服务     |
+------------------+       +------------------+
         ↓                           ↓
+------------------+       +------------------+
|   退款服务        |       |   对账服务        |
+------------------+       +------------------+
         ↓                           ↓
+------------------+       +------------------+
|   风控服务        |       |   账户服务        |
+------------------+       +------------------+
```

---

### **6. 技术选型总结**

| **模块**   | **技术栈**                                   |
|----------|-------------------------------------------|
| **网关**   | Spring Cloud Gateway + OAuth2             |
| **支付核心** | Spring Boot + MyBatis-Plus + Seata（分布式事务） |
| **渠道适配** | 各支付渠道 SDK + OpenFeign（HTTP 调用）            |
| **风控**   | Drools + Redis（规则引擎与实时风控）                 |
| **消息队列** | RabbitMQ（事务消息） / Kafka（日志与对账）             |
| **监控**   | Prometheus + Grafana + SkyWalking         |

---

### **7. 关键设计点**

1. **服务隔离**：按支付渠道拆分适配服务，避免单点故障影响全局。
2. **异步化**：支付结果通知、对账等操作通过消息队列异步处理。
3. **幂等性**：支付接口设计需支持重试（如订单号唯一键）。
4. **灾备方案**：多机房部署 + 数据库主从同步。
