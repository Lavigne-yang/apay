# apay聚合支付

实现一个简化版聚合支付系统，支持微信支付、支付宝沙箱模拟对接，覆盖支付核心流程（创建订单、支付路由、回调通知、对账），避免电商复杂业务（如库存、物流）。

## 项目技术架构

### 技术架构

- **框架**：Spring Boot（快速搭建）+ MyBatis（数据持久化）
- **数据库**：MySQL（订单表、渠道配置表）+ Redis（订单状态缓存、分布式锁）
- **消息队列**：RocketMQ/Kafka（异步处理支付回调、对账任务）
- **API网关**：Spring Cloud Gateway（统一鉴权、限流）
- **安全**：JWT（用户鉴权）、接口签名（防篡改）

### 项目结构

```

```

## 核心功能

1. **订单服务**
   - 生成支付订单（含金额、支付方式、超时时间）
   - 订单状态管理（待支付、已支付、已关闭）
2. **支付路由**
   - 根据支付方式（微信/支付宝）选择对应渠道接口
   - 支持失败自动切换备用渠道（模拟容灾）
3. **渠道对接**
   - 微信/支付宝沙箱环境对接（使用官方SDK或模拟接口）
   - 处理同步/异步回调（验证签名、更新订单状态）
4. **对账服务**
   - 每日定时拉取渠道交易流水
   - 比对本地订单与渠道数据，标记差异订单

## 重点目标

### **支付业务逻辑**

- **状态机设计**：订单状态流转（待支付→已支付/已关闭）
- **超时关单**：消息延时队列扫描未支付订单，关闭订单并发布通知
- **渠道兼容性**：抽象支付接口，实现微信/支付宝差异化参数处理

### 2. **技术难点**

- **分布式锁**：使用Redis实现订单更新锁（防止并发支付）
- **数据一致性**：本地事务 + 消息队列（如支付成功更新订单并发送通知）
- **安全风控**：模拟风控拦截（如黑名单用户、高频支付检测）

### 3. **扩展性设计**

- **插件化支付渠道**：通过策略模式扩展新支付方式（如PayPal）
- **配置化路由**：数据库存储渠道权重、费率，动态选择最优渠道